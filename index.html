<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”å½±æ§‹åœ–å¤§æ–½ï¼šæ¥µç«¯å¼µåŠ›ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', "Microsoft JhengHei", sans-serif;
            background-color: #0a0a0a;
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API é‡‘é‘°ç”±å¾Œç«¯æˆ–ç’°å¢ƒè®Šæ•¸æ³¨å…¥ï¼Œæ­¤è™•ä¿æŒç‚ºç©º
        const API_KEY = ""; 

        const COMPOSITION_METHODS = [
            "ä¸­å¿ƒæ§‹åœ–æ³•", "äº•å­—æ§‹åœ–æ³•", "å°ç¨±æ§‹åœ–æ³•", "æ¡†æ¶æ§‹åœ–æ³•", "å¼•å°ç·šæ§‹åœ–æ³•", "å‰æ™¯æ§‹åœ–æ³•", 
            "ç•™ç™½æ§‹åœ–æ³•", "å°è§’ç·šæ§‹åœ–æ³•", "Så‹æ›²ç·šæ§‹åœ–æ³•", "é‡è¤‡åœ–æ¡ˆæ§‹åœ–æ³•", "åˆ‡é‚Šæ§‹åœ–æ³•", 
            "å¡«å……å¼æ§‹åœ–", "å°ç¨±å¹³è¡¡æ§‹åœ–æ³•", "å°è§’ç·šå¹³è¡¡æ§‹åœ–æ³•", "ç‰©é«”å¤§å°å¹³è¡¡æ§‹åœ–æ³•", 
            "è‰²å½©å¹³è¡¡æ§‹åœ–æ³•", "è‰²èª¿(æ˜æš—)å¹³è¡¡æ§‹åœ–æ³•"
        ];

        // ä¿®æ­£å¾Œçš„ Icon çµ„ä»¶ï¼Œç›¸å®¹æœ€æ–°ç‰ˆ Lucide CDN
        const Icon = ({ name, className }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    // å»ºç«‹ä¸€å€‹è‡¨æ™‚å®¹å™¨ä¾†ç”Ÿæˆåœ–æ¨™
                    const iconName = name.charAt(0).toLowerCase() + name.slice(1);
                    const iconData = window.lucide.icons[name] || window.lucide.icons[iconName];
                    
                    if (iconData) {
                        // ä½¿ç”¨ Lucide çš„ createElement æ–¹æ³•ä¾†ç”Ÿæˆ SVG
                        const svgElement = window.lucide.createElement(iconData);
                        // è¨­ç½®æ¨£å¼é¡åˆ¥
                        if (className) {
                            className.split(' ').forEach(cls => {
                                if (cls) svgElement.classList.add(cls);
                            });
                        }
                        // æ›¿æ›å…§å®¹
                        iconRef.current.innerHTML = '';
                        iconRef.current.appendChild(svgElement);
                    }
                }
            }, [name, className]);

            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const App = () => {
            const [image, setImage] = useState(null);
            const [base64Image, setBase64Image] = useState(null);
            const [loading, setLoading] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [error, setError] = useState(null);
            const [generatingImage, setGeneratingImage] = useState(false);
            const [retryStatus, setRetryStatus] = useState(null);
            const [aiSampleUrl, setAiSampleUrl] = useState(null);
            const [loadingText, setLoadingText] = useState("");
            const fileInputRef = useRef(null);
            const aiSampleRef = useRef(null);

            const loadingMessages = [
                "å¤§æ–½æ­£æ—¥ä»¥ç¹¼å¤œçš„åˆ†æä¸­", "å¤§æ–½æ­£ç—›ä¸æ¬²ç”Ÿçš„åˆ†æä¸­", "å¤§æ–½æ­£ä¸çœ ä¸ä¼‘çš„åˆ†æä¸­",
                "å¤§æ–½æ­£éš¨å¿ƒæ‰€æ¬²çš„åˆ†æä¸­", "å¤§æ–½æ­£å¿«é¦¬åŠ é­çš„åˆ†æä¸­", "å¤§æ–½æ­£å»¢å¯¢å¿˜é£Ÿçš„åˆ†æä¸­",
                "å¤§æ–½æ­£é¾œé€Ÿçš„åˆ†æä¸­", "å¤§æ–½æ­£ç”Ÿç„¡å¯æˆ€çš„åˆ†æä¸­", "å¤§æ–½æ­£é€£æ»¾å¸¶çˆ¬çš„åˆ†æä¸­",
                "å¤§æ–½æ­£å¾å¾å®¹å®¹çš„åˆ†æä¸­", "å¤§æ–½æ­£è¬èˆ¬ç„¡å¥ˆçš„åˆ†æä¸­", "å¤§æ–½æ­£å¿ƒä¸ç”˜æƒ…ä¸é¡˜çš„åˆ†æä¸­",
                "å¤§æ–½æ­£å…‰é€Ÿçš„åˆ†æä¸­"
            ];

            const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½é¢¨è¶£ä½†å°ˆæ¥­çš„æ”å½±å°å¸«ã€Œå¤§æ–½ã€ï¼Œè² è²¬æä¾›ç…§ç‰‡æ§‹åœ–åˆ†æã€‚
è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
1. èªæ°£å°ˆæ¥­ã€å¸¶é»å¹½é»˜ã€‚
2. é‡å°ã€Œç›®å‰æ§‹åœ–æ–¹å¼ã€é€²è¡Œåˆ†æã€‚
3. åªèƒ½å¾æŒ‡å®š17ç¨®æ§‹åœ–æ³•ä¸­é¸æ“‡ã€‚
4. è¦–è¦ºå¼µåŠ›è©•åˆ† (æ¥µç«¯æ‹‰å¤§å·®è·æ¨¡å¼)ï¼š
   - ç¯„åœ 3.5 åˆ° 10.0ã€‚
   - åš´ç¦ä¸­åº¸åˆ†æ•¸ã€‚å°ˆæ¥­æ„Ÿ 7.5 èµ·è·³ï¼Œå¹³åº¸å£“ä½è‡³ 6.0 ä»¥ä¸‹ï¼Œæœ€ä½ 3.5ã€‚
5. å°ˆæ¥­é»è©•ä¸­åš´ç¦å‡ºç¾ã€Œå¤§æ–½ã€å­—æ¨£ã€‚
è¼¸å‡ºæ ¼å¼ï¼š
æ§‹åœ–åˆ†æçµæœï¼š(åƒ…ä¸­æ–‡åç¨±)
è¦–è¦ºå¼µåŠ›è©•åˆ†ï¼š(æ•¸å­—)
å°ˆæ¥­é»è©•ï¼š(å…§å®¹)
äºŒæ¬¡æ§‹åœ–å„ªåŒ–æ–¹æ¡ˆï¼š(å»ºè­°)
è¦–è¦ºè™•ç†æŒ‡ä»¤ï¼š(è‹±æ–‡æè¿°)`;

            const callGemini = async (model, payload, retryCount = 0) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if ((response.status === 429 || response.status >= 500) && retryCount < 5) {
                            const delay = Math.pow(2, retryCount) * 1500;
                            setRetryStatus(`ä¼ºæœå™¨å¿™ç¢Œï¼Œé€²è¡Œç¬¬ ${retryCount + 1} æ¬¡é‡è©¦...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return callGemini(model, payload, retryCount + 1);
                        }
                        throw new Error(`API Error ${response.status}`);
                    }
                    const result = await response.json();
                    setRetryStatus(null);
                    return result;
                } catch (err) {
                    if (retryCount < 5) {
                        const delay = Math.pow(2, retryCount) * 1500;
                        setRetryStatus(`é€£ç·šç•°å¸¸ï¼Œé‡è©¦ä¸­ (${retryCount + 1}/5)...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGemini(model, payload, retryCount + 1);
                    }
                    throw err;
                }
            };

            const parseAnalysis = (text) => {
                const cleanSymbols = (str) => str ? str.replace(/[*#|]/g, '').trim() : "";
                const splitToParagraphs = (str) => {
                    const cleaned = cleanSymbols(str);
                    return cleaned ? cleaned.split(/[\n\r]+/).flatMap(p => p.split(/(?<=[ã€‚ï¼ï¼Ÿ])\s*/).filter(s => s.trim().length > 0)) : [];
                };

                const typeRaw = cleanSymbols(text.match(/æ§‹åœ–åˆ†æçµæœï¼š?([\s\S]+?)(?=è¦–è¦ºå¼µåŠ›è©•åˆ†|å°ˆæ¥­é»è©•|äºŒæ¬¡æ§‹åœ–|è¦–è¦ºè™•ç†|$)/)?.[1]);
                let types = COMPOSITION_METHODS.filter(method => typeRaw.includes(method));
                if (types.length === 0) types = typeRaw.split(/[ã€,ï¼Œ\s]+/).filter(t => t.length > 0);

                const scoreMatch = text.match(/è¦–è¦ºå¼µåŠ›è©•åˆ†[:ï¼š\s]*(\d+(\.\d)?)/);
                const score = scoreMatch ? scoreMatch[1] : "3.5";

                return {
                    typeList: types,
                    score: score,
                    comment: splitToParagraphs(text.match(/å°ˆæ¥­é»è©•ï¼š?([\s\S]+?)(?=äºŒæ¬¡æ§‹åœ–|è¦–è¦ºè™•ç†|$)/)?.[1]?.trim()),
                    guide: splitToParagraphs(text.match(/äºŒæ¬¡æ§‹åœ–å„ªåŒ–æ–¹æ¡ˆï¼š?([\s\S]+?)(?=è¦–è¦ºè™•ç†|$)/)?.[1]?.trim()),
                    prompt: text.match(/è¦–è¦ºè™•ç†æŒ‡ä»¤ï¼š?([\s\S]+?)$/)?.[1]?.trim() || ""
                };
            };

            const analyzeComposition = async () => {
                setLoading(true);
                setError(null);
                try {
                    const data = await callGemini('gemini-2.5-flash-preview-09-2025', {
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: "image/png", data: base64Image } },
                                { text: "è«‹é€²è¡Œæ§‹åœ–åˆ†æï¼Œå¤§å¹…æ‹‰é–‹è©•åˆ†å·®è·ã€‚" }
                            ]
                        }],
                        systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                    });

                    if (data.candidates?.[0]?.finishReason === "SAFETY") throw new Error("å½±åƒå…§å®¹ä¸ç¬¦åˆè¦ç¯„ã€‚");
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) setAnalysis(parseAnalysis(text));
                } catch (err) {
                    setError("åˆ†æå¤±æ•—ï¼š" + err.message);
                } finally {
                    setLoading(false);
                    setRetryStatus(null);
                }
            };

            const generateIdealCrop = async () => {
                if (!base64Image || !analysis) return;
                setGeneratingImage(true);
                setError(null);
                try {
                    const forcedPrompt = `TASK: RE-COMPOSE AND TRANSFORM THIS IMAGE. CROP, ROTATE, AND FOLLOW RULE OF THIRDS. INSTRUCTIONS: ${analysis.guide.join(" ")}. STYLE: ${analysis.prompt}. Output modified image only.`;
                    
                    const result = await callGemini('gemini-2.5-flash-image-preview', {
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: "image/png", data: base64Image } },
                                { text: forcedPrompt }
                            ]
                        }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                    });

                    const imagePart = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                    if (imagePart?.inlineData?.data) {
                        setAiSampleUrl(`data:image/png;base64,${imagePart.inlineData.data}`);
                        setTimeout(() => aiSampleRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                    } else {
                        throw new Error("æ¨¡å‹æœªå›å‚³å½±åƒã€‚");
                    }
                } catch (e) {
                    setError("ç”Ÿæˆå¤±æ•—ï¼š" + e.message);
                } finally {
                    setGeneratingImage(false);
                    setRetryStatus(null);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                        setBase64Image(reader.result.split(',')[1]);
                        setAnalysis(null);
                        setAiSampleUrl(null);
                        setError(null);
                    };
                    reader.readAsDataURL(file);
                }
            };

            useEffect(() => {
                if (base64Image) {
                    setLoadingText(loadingMessages[Math.floor(Math.random() * loadingMessages.length)]);
                    analyzeComposition();
                }
            }, [base64Image]);

            const getRank = (scoreStr) => {
                const score = parseFloat(scoreStr);
                if (score >= 9.5) return "ä½ é€™ä¸€ç”Ÿå€¼å¾—äº†";
                if (score >= 9.0) return "æ§‹åœ–å¯©ç¾å¤©èŠ±æ¿";
                if (score >= 8.5) return "å®Œç¾çš„é»ƒé‡‘æ¯”ä¾‹";
                if (score >= 8.0) return "å…‰å½±é­”è¡“å¸«å°±æ˜¯ä½ ";
                if (score >= 7.5) return "ç¾æ„Ÿå°ˆæ¥­å¤§å¸«";
                if (score >= 7.0) return "å”‰å‘¦ï¼Œä¸éŒ¯å–”";
                if (score >= 6.5) return "é€™å¼µå®‰å…¨ç‰Œæ‰“å¾—å¥½";
                if (score >= 6.0) return "ç­”æ‡‰æˆ‘ï¼ŒåŠ æ²¹å¥½å—";
                if (score >= 5.5) return "ä½ é˜¿å¬¤éƒ½æ¯”ä½ æœƒæ‹";
                if (score >= 5.0) return "ç¾æ„Ÿçµ•ç·£é«”å°±æ˜¯ä½ ";
                if (score >= 4.5) return "è¦–è¦ºç³»ææ€–ä»½å­";
                if (score >= 4.0) return "å ªæ¯”è¦–è¦ºç½é›£ç¾å ´";
                return "æˆ‘å‹¸ä½ å¿«å›ç«æ˜Ÿå§";
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
                    <header className="max-w-2xl w-full text-center mb-10">
                        <h1 className="text-3xl md:text-4xl font-black tracking-widest text-white mb-2 italic">æ”å½±æ§‹åœ–å¤§æ–½</h1>
                        <p className="text-neutral-500 text-xs font-bold tracking-[0.3em]">ğŸš€ æ‹¯æ•‘ç³Ÿç³•æ§‹åœ– Â· è®“ç…§ç‰‡èµ·æ­»å›ç”Ÿ</p>
                    </header>

                    <main className="max-w-5xl w-full grid grid-cols-1 lg:grid-cols-2 gap-10 items-start">
                        <div className="space-y-6">
                            <div className="bg-neutral-900 border border-neutral-800 rounded-[2.5rem] overflow-hidden shadow-2xl relative">
                                {!image ? (
                                    <div onClick={() => fileInputRef.current.click()} className="aspect-[3/4] flex flex-col items-center justify-center p-12 cursor-pointer hover:bg-neutral-800/50 transition-all border-4 border-dashed border-neutral-800 m-4 rounded-[2rem] group">
                                        <div className="w-20 h-20 text-blue-500 mb-6 group-hover:scale-110 transition-transform"><Icon name="Camera" className="w-full h-full" /></div>
                                        <div className="text-white font-black text-xl tracking-widest">ä¸Šå‚³ç…§ç‰‡</div>
                                        <p className="text-neutral-500 text-xs mt-4">å¤§æ–½å¹«ä½ çœ‹çœ‹é€™å¼µé‚„æœ‰æ²’æœ‰æ•‘</p>
                                    </div>
                                ) : (
                                    <div className="relative">
                                        <img src={image} className="w-full h-auto block" />
                                        {loading && (
                                            <div className="absolute inset-0 bg-black/70 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center">
                                                <div className="text-blue-500 animate-spin mb-6"><Icon name="RefreshCw" className="w-12 h-12" /></div>
                                                <p className="text-white font-black tracking-widest text-sm">{retryStatus || loadingText}</p>
                                            </div>
                                        )}
                                        <button onClick={() => {setImage(null); setAnalysis(null);}} className="absolute top-6 right-6 bg-black/50 hover:bg-black p-3 rounded-full backdrop-blur-md border border-white/10 transition-all">
                                            <Icon name="RefreshCw" className="w-6 h-6 text-white" />
                                        </button>
                                    </div>
                                )}
                                <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                            </div>

                            {aiSampleUrl && (
                                <div ref={aiSampleRef} className="bg-neutral-900 border border-blue-900/30 rounded-[2.5rem] overflow-hidden shadow-2xl animate-bounce-in">
                                    <div className="p-5 bg-blue-950/20 flex items-center justify-between border-b border-blue-900/30">
                                        <div className="flex items-center gap-3 text-blue-400 font-black text-sm tracking-widest">
                                            <Icon name="Wand2" className="w-5 h-5" /> ç†æƒ³æ§‹åœ–åƒè€ƒ
                                        </div>
                                        <button onClick={() => setAiSampleUrl(null)} className="text-neutral-500 hover:text-white"><Icon name="X" className="w-4 h-4" /></button>
                                    </div>
                                    <img src={aiSampleUrl} className="w-full h-auto" />
                                </div>
                            )}
                        </div>

                        <div className="space-y-8">
                            {analysis && (
                                <div className="space-y-8 animate-slide-in">
                                    <div className="bg-white text-black rounded-[2rem] p-8 shadow-2xl border-b-[10px] border-blue-600 flex justify-between items-center">
                                        <div className="space-y-4">
                                            <div className="inline-block px-3 py-1 bg-blue-600 text-white font-black text-[10px] rounded uppercase tracking-tighter">Current Composition</div>
                                            <div className="space-y-1">
                                                {analysis.typeList.map((t, i) => (
                                                    <div key={i} className="flex items-center gap-2 font-black text-lg text-neutral-800 tracking-tight">
                                                        <div className="w-2 h-2 bg-blue-600 rounded-full" /> {t}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="text-right border-l-2 border-neutral-200 pl-8">
                                            <div className="text-[10px] font-black text-neutral-400 tracking-widest mb-1 uppercase">Score</div>
                                            <div className="flex items-baseline justify-end">
                                                <span className="text-6xl font-black text-blue-600 leading-none">{analysis.score}</span>
                                                <span className="text-xs font-bold text-neutral-400 ml-1">/10</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-neutral-800/50 border border-neutral-700 rounded-[2rem] p-6 flex items-center gap-5 shadow-xl">
                                        <div className="bg-blue-600 p-4 rounded-2xl shadow-lg shadow-blue-600/20"><Icon name="Award" className="w-8 h-8 text-white" /></div>
                                        <div>
                                            <div className="text-[10px] font-bold text-blue-400 tracking-[0.2em] uppercase mb-1">ç¾æ„Ÿç­‰ç´šè©•å®š</div>
                                            <div className="text-xl font-black text-white italic tracking-wide">{getRank(analysis.score)}</div>
                                        </div>
                                    </div>

                                    <div className="bg-neutral-900 border border-neutral-800 rounded-[2.5rem] p-8 space-y-6 shadow-2xl relative overflow-hidden">
                                        <div className="flex items-center gap-3 text-blue-500 font-black tracking-widest text-lg border-b border-neutral-800 pb-4 uppercase">
                                            <Icon name="User" className="w-6 h-6" /> å¤§æ–½å°ˆæ¥­é»è©•
                                        </div>
                                        <div className="space-y-4 text-neutral-300 leading-relaxed font-medium">
                                            {analysis.comment.map((p, i) => <p key={i}>{p}</p>)}
                                        </div>
                                    </div>

                                    <div className="bg-blue-600 text-white rounded-[2.5rem] p-10 shadow-2xl shadow-blue-600/20 space-y-8 relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-10 opacity-10 pointer-events-none"><Icon name="Scissors" className="w-32 h-32" /></div>
                                        <div className="flex items-center gap-3 font-black tracking-widest text-xl uppercase">
                                            <Icon name="Layout" className="w-6 h-6" /> ç†æƒ³æ§‹åœ–å»ºè­°
                                        </div>
                                        <div className="space-y-4 text-blue-50 leading-relaxed font-bold italic">
                                            {analysis.guide.map((p, i) => <p key={i}>{p}</p>)}
                                        </div>
                                        <button 
                                            onClick={generateIdealCrop} 
                                            disabled={generatingImage}
                                            className="w-full bg-white text-blue-600 py-6 rounded-2xl font-black text-sm tracking-[0.2em] flex flex-col items-center justify-center gap-2 hover:bg-neutral-100 transition-all disabled:opacity-50 shadow-xl"
                                        >
                                            <div className="flex items-center gap-3">
                                                {generatingImage ? <Icon name="RefreshCw" className="w-5 h-5 animate-spin" /> : <Icon name="Layers" className="w-5 h-5" />}
                                                {generatingImage ? "æ­£åœ¨åŠªåŠ›æ§‹åœ–ä¸­..." : "ç”Ÿæˆç†æƒ³è£åˆ‡ç¤ºæ„åœ–"}
                                            </div>
                                            {retryStatus && <span className="text-[10px] animate-pulse font-medium">{retryStatus}</span>}
                                        </button>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="p-6 bg-red-950/30 border border-red-900/50 rounded-3xl flex items-start gap-4 text-red-400 animate-shake">
                                    <Icon name="AlertCircle" className="w-6 h-6 shrink-0" />
                                    <p className="text-xs font-bold leading-relaxed">{error}</p>
                                </div>
                            )}
                        </div>
                    </main>

                    <footer className="mt-20 text-neutral-600 text-[10px] font-black tracking-[0.5em] text-center uppercase">
                        Â© çœŸçš„å¤§æ–½æ•™ä½ æ‹ç¾ç…§ ï¼ å‡çš„å¤§å¸«å®³ä½ è¢«ç½µçˆ†
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
